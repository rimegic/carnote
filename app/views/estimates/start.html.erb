<!-- Estimate Start Page -->
<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">ì‹ ì°¨ í• ë¶€ ê²¬ì </h1>
          <p class="text-gray-600 mt-1">ìµœì ì˜ í• ë¶€ ì¡°ê±´ì„ ë¹„êµí•´ë³´ì„¸ìš”</p>
        </div>
        <%= link_to "â† í™ˆìœ¼ë¡œ", root_path, class: "text-blue-600 hover:text-blue-700 font-medium" %>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: Car Selection -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">ì°¨ëŸ‰ ì„ íƒ</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ë¸Œëœë“œ</label>
              <select id="brand-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">ë¸Œëœë“œ ì„ íƒ</option>
                <option value="í˜„ëŒ€" <%= 'selected' if @brand == 'í˜„ëŒ€' %>>í˜„ëŒ€</option>
                <option value="ê¸°ì•„" <%= 'selected' if @brand == 'ê¸°ì•„' %>>ê¸°ì•„</option>
                <option value="ì œë„¤ì‹œìŠ¤" <%= 'selected' if @brand == 'ì œë„¤ì‹œìŠ¤' %>>ì œë„¤ì‹œìŠ¤</option>
                <option value="BMW" <%= 'selected' if @brand == 'BMW' %>>BMW</option>
                <option value="ë²¤ì¸ " <%= 'selected' if @brand == 'ë²¤ì¸ ' %>>ë²¤ì¸ </option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ëª¨ë¸</label>
              <select id="model-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" <%= 'disabled' unless @brand %>>
                <option value="">ëª¨ë¸ ì„ íƒ</option>
              </select>
            </div>
          </div>

          <!-- Selected Car Display -->
          <div id="selected-car" class="hidden">
            <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
              <div class="flex items-center space-x-4">
                <img id="car-image" src="" alt="" class="w-20 h-16 object-cover rounded-lg">
                <div>
                  <h3 id="car-name" class="text-lg font-semibold text-gray-900"></h3>
                  <p id="car-price" class="text-xl font-bold text-blue-600"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loan Conditions -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">í• ë¶€ ì¡°ê±´</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ì°¨ëŸ‰ ê°€ê²©</label>
              <input type="number" id="car-price-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì°¨ëŸ‰ ê°€ê²©" readonly>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ì„ ìˆ˜ê¸ˆ</label>
              <input type="number" id="down-payment" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="ì„ ìˆ˜ê¸ˆ ì…ë ¥">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">í• ë¶€ ê¸°ê°„</label>
              <select id="loan-period" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">ê¸°ê°„ ì„ íƒ</option>
                <option value="12">12ê°œì›”</option>
                <option value="24">24ê°œì›”</option>
                <option value="36">36ê°œì›”</option>
                <option value="48">48ê°œì›”</option>
                <option value="60">60ê°œì›”</option>
                <option value="72">72ê°œì›”</option>
                <option value="84">84ê°œì›”</option>
              </select>
              <div id="loan-period-error" class="hidden mt-2 text-sm text-red-600 flex items-center">
                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                í• ë¶€ ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">í• ë¶€ ê¸ˆì•¡</label>
              <input type="number" id="loan-amount" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="ìë™ ê³„ì‚°" readonly>
            </div>
          </div>
          
          <button id="calculate-btn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
            í• ë¶€ ê²¬ì  ê³„ì‚°í•˜ê¸°
          </button>
        </div>
      </div>

      <!-- Right: Loan Estimates -->
      <div class="lg:col-span-1">
        <!-- Chat Modal (moved here) -->
        <div id="chat-modal" class="bg-white rounded-xl shadow-sm border border-gray-200 hidden mb-6">
          <!-- Chat Header -->
          <div class="bg-blue-600 text-white p-4 rounded-t-xl flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                <span class="text-blue-600 font-bold text-sm">ğŸš—</span>
              </div>
              <div>
                <h3 class="font-semibold">ì¹´ë…¸íŠ¸ ìƒë‹´ì‚¬</h3>
                <p class="text-xs text-blue-100">ì˜¨ë¼ì¸</p>
              </div>
            </div>
            <button id="close-chat" class="text-white hover:text-blue-200 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <!-- Chat Messages -->
          <div id="chat-messages" class="h-60 overflow-y-auto p-4 space-y-3 bg-gray-50">
            <!-- Messages will be added here -->
          </div>

          <!-- Chat Input -->
          <div class="p-4 border-t border-gray-200 bg-white rounded-b-xl">
            <div class="flex space-x-2">
              <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                     class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
              <button id="send-message" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm p-6 sticky top-6 mb-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">í• ë¶€ ê²¬ì  ë¹„êµ</h2>
          
          <div id="estimates-container" class="space-y-4">
            <div class="text-center py-8 text-gray-500">
              <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              <p>ì°¨ëŸ‰ê³¼ ì¡°ê±´ì„ ì„ íƒí•˜ë©´<br>í• ë¶€ ê²¬ì ì´ í‘œì‹œë©ë‹ˆë‹¤</p>
            </div>
          </div>
        </div>

        <!-- Location Section -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-gray-900">ğŸ“ í˜„ì¬ ìœ„ì¹˜</h2>
            <button id="get-location-btn" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium py-2 px-4 rounded-lg transition duration-200 flex items-center space-x-2">
              <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
              </svg>
              <span>ìœ„ì¹˜ ì°¾ê¸°</span>
            </button>
          </div>
          
          <div id="location-status" class="mb-4">
            <div class="flex items-center text-gray-500">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...
            </div>
          </div>

          <div id="location-info" class="hidden">
            <div class="space-y-3">
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-green-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">í˜„ì¬ ì£¼ì†Œ</p>
                  <p id="current-address" class="text-sm text-gray-600">ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
                </div>
              </div>
              
              <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                  <svg class="h-5 w-5 text-blue-500 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                  </svg>
                </div>
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">ì¢Œí‘œ</p>
                  <p id="coordinates" class="text-sm text-gray-600">ìœ„ë„: -, ê²½ë„: -</p>
                </div>
              </div>
            </div>

            <!-- Nearby Dealers Section -->
            <div class="mt-6 pt-6 border-t border-gray-200">
              <h3 class="text-lg font-medium text-gray-900 mb-3">ğŸª ê·¼ì²˜ ë”œëŸ¬ìƒµ</h3>
              <div id="nearby-dealers" class="space-y-3">
                <!-- ë”œëŸ¬ìƒµ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
              </div>
            </div>
          </div>

          <div id="location-error" class="hidden">
            <div class="flex items-center space-x-3 text-red-600">
              <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              <div>
                <p class="font-medium">ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>
                <p class="text-sm text-red-500">ë¸Œë¼ìš°ì €ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”</p>
              </div>
            </div>
            
            <button id="retry-location" class="mt-3 w-full bg-red-50 hover:bg-red-100 text-red-700 font-medium py-2 px-4 rounded-lg transition duration-200">
              ë‹¤ì‹œ ì‹œë„
            </button>
          </div>

          <!-- Manual Location Input -->
          <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="text-lg font-medium text-gray-900 mb-3">ğŸ“ ìˆ˜ë™ ìœ„ì¹˜ ì…ë ¥</h3>
            <div class="space-y-3">
              <input type="text" id="manual-address" placeholder="ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™)" 
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <button id="search-address" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-lg transition duration-200">
                ì£¼ì†Œë¡œ ê²€ìƒ‰
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Popup Modal -->
<div id="quote-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
      <div id="quote-content">
        <!-- Quote content will be loaded here -->
      </div>
    </div>
  </div>
</div>


<script>
  const carData = {
    "í˜„ëŒ€": {
      "ì•„ë°˜ë–¼": { price: 20900000, image: "/generated_images/car_1.jpg" },
      "ì˜ë‚˜íƒ€": { price: 28990000, image: "/generated_images/car_2.jpg" },
      "ê·¸ëœì €": { price: 35200000, image: "/generated_images/car_3.jpg" },
      "ì•„ì´ì˜¤ë‹‰5": { price: 52000000, image: "/generated_images/car_1.jpg" },
      "ì•„ì´ì˜¤ë‹‰6": { price: 52900000, image: "/generated_images/car_2.jpg" },
      "íˆ¬ì‹¼": { price: 27550000, image: "/generated_images/car_3.jpg" },
      "ì‹¼íƒ€í˜": { price: 35150000, image: "/generated_images/car_4.jpg" },
      "íŒ°ë¦¬ì„¸ì´ë“œ": { price: 38380000, image: "/generated_images/car_5.jpg" },
      "ìºìŠ¤í¼": { price: 13850000, image: "/generated_images/car_6.jpg" },
      "ë² ë‰´": { price: 19690000, image: "/generated_images/car_1.jpg" }
    },
    "ê¸°ì•„": {
      "K3": { price: 19550000, image: "/generated_images/car_4.jpg" },
      "K5": { price: 27600000, image: "/generated_images/car_5.jpg" },
      "K8": { price: 33050000, image: "/generated_images/car_6.jpg" },
      "K9": { price: 46300000, image: "/generated_images/car_1.jpg" },
      "EV6": { price: 48800000, image: "/generated_images/car_2.jpg" },
      "EV9": { price: 73000000, image: "/generated_images/car_3.jpg" },
      "ì…€í† ìŠ¤": { price: 22680000, image: "/generated_images/car_4.jpg" },
      "ìŠ¤í¬í‹°ì§€": { price: 27550000, image: "/generated_images/car_5.jpg" },
      "ì˜ë Œí† ": { price: 31930000, image: "/generated_images/car_6.jpg" },
      "ëª¨í•˜ë¹„": { price: 41730000, image: "/generated_images/car_1.jpg" },
      "ë ˆì´": { price: 14350000, image: "/generated_images/car_2.jpg" },
      "ëª¨ë‹": { price: 12850000, image: "/generated_images/car_3.jpg" }
    },
    "ì œë„¤ì‹œìŠ¤": {
      "G70": { price: 45000000, image: "/generated_images/car_4.jpg" },
      "G80": { price: 54050000, image: "/generated_images/car_5.jpg" },
      "G90": { price: 87000000, image: "/generated_images/car_6.jpg" },
      "GV70": { price: 50300000, image: "/generated_images/car_1.jpg" },
      "GV80": { price: 69300000, image: "/generated_images/car_2.jpg" },
      "GV60": { price: 59900000, image: "/generated_images/car_3.jpg" },
      "ì „ë™í™” G80": { price: 77550000, image: "/generated_images/car_4.jpg" },
      "ì „ë™í™” GV70": { price: 65800000, image: "/generated_images/car_5.jpg" }
    },
    "BMW": {
      "1ì‹œë¦¬ì¦ˆ": { price: 42000000, image: "/generated_images/car_6.jpg" },
      "2ì‹œë¦¬ì¦ˆ": { price: 48900000, image: "/generated_images/car_1.jpg" },
      "3ì‹œë¦¬ì¦ˆ": { price: 55000000, image: "/generated_images/car_2.jpg" },
      "4ì‹œë¦¬ì¦ˆ": { price: 62000000, image: "/generated_images/car_3.jpg" },
      "5ì‹œë¦¬ì¦ˆ": { price: 74000000, image: "/generated_images/car_4.jpg" },
      "7ì‹œë¦¬ì¦ˆ": { price: 139000000, image: "/generated_images/car_5.jpg" },
      "X1": { price: 47500000, image: "/generated_images/car_6.jpg" },
      "X3": { price: 62000000, image: "/generated_images/car_1.jpg" },
      "X5": { price: 89000000, image: "/generated_images/car_2.jpg" },
      "X7": { price: 124000000, image: "/generated_images/car_3.jpg" },
      "iX3": { price: 77000000, image: "/generated_images/car_4.jpg" },
      "i4": { price: 69990000, image: "/generated_images/car_5.jpg" }
    },
    "ë²¤ì¸ ": {
      "Aí´ë˜ìŠ¤": { price: 42000000, image: "/generated_images/car_6.jpg" },
      "Cí´ë˜ìŠ¤": { price: 55000000, image: "/generated_images/car_1.jpg" },
      "Eí´ë˜ìŠ¤": { price: 72000000, image: "/generated_images/car_2.jpg" },
      "Sí´ë˜ìŠ¤": { price: 135000000, image: "/generated_images/car_3.jpg" },
      "GLA": { price: 47500000, image: "/generated_images/car_4.jpg" },
      "GLB": { price: 52000000, image: "/generated_images/car_5.jpg" },
      "GLC": { price: 64000000, image: "/generated_images/car_6.jpg" },
      "GLE": { price: 89000000, image: "/generated_images/car_1.jpg" },
      "GLS": { price: 128000000, image: "/generated_images/car_2.jpg" },
      "EQA": { price: 59990000, image: "/generated_images/car_3.jpg" },
      "EQB": { price: 64990000, image: "/generated_images/car_4.jpg" },
      "EQC": { price: 89990000, image: "/generated_images/car_5.jpg" }
    },
    "ì•„ìš°ë””": {
      "A3": { price: 42000000, image: "/generated_images/car_6.jpg" },
      "A4": { price: 55000000, image: "/generated_images/car_1.jpg" },
      "A6": { price: 72000000, image: "/generated_images/car_2.jpg" },
      "A8": { price: 129000000, image: "/generated_images/car_3.jpg" },
      "Q2": { price: 41000000, image: "/generated_images/car_4.jpg" },
      "Q3": { price: 48900000, image: "/generated_images/car_5.jpg" },
      "Q5": { price: 64000000, image: "/generated_images/car_6.jpg" },
      "Q7": { price: 92000000, image: "/generated_images/car_1.jpg" },
      "Q8": { price: 105000000, image: "/generated_images/car_2.jpg" },
      "e-tron": { price: 99990000, image: "/generated_images/car_3.jpg" },
      "e-tron GT": { price: 139990000, image: "/generated_images/car_4.jpg" }
    },
    "ë³¼ë³´": {
      "XC40": { price: 45900000, image: "/generated_images/car_5.jpg" },
      "XC60": { price: 62000000, image: "/generated_images/car_6.jpg" },
      "XC90": { price: 82000000, image: "/generated_images/car_1.jpg" },
      "S60": { price: 49900000, image: "/generated_images/car_2.jpg" },
      "S90": { price: 65000000, image: "/generated_images/car_3.jpg" },
      "XC40 ë¦¬ì°¨ì§€": { price: 59990000, image: "/generated_images/car_4.jpg" },
      "XC60 ë¦¬ì°¨ì§€": { price: 74990000, image: "/generated_images/car_5.jpg" },
      "XC90 ë¦¬ì°¨ì§€": { price: 94990000, image: "/generated_images/car_6.jpg" }
    },
    "ë ‰ì„œìŠ¤": {
      "IS": { price: 47000000, image: "/generated_images/car_1.jpg" },
      "ES": { price: 55000000, image: "/generated_images/car_2.jpg" },
      "LS": { price: 119000000, image: "/generated_images/car_3.jpg" },
      "NX": { price: 52000000, image: "/generated_images/car_4.jpg" },
      "RX": { price: 72000000, image: "/generated_images/car_5.jpg" },
      "GX": { price: 95000000, image: "/generated_images/car_6.jpg" },
      "LX": { price: 135000000, image: "/generated_images/car_1.jpg" },
      "UX": { price: 42000000, image: "/generated_images/car_2.jpg" },
      "LC": { price: 129000000, image: "/generated_images/car_3.jpg" }
    }
  };

  let selectedBrand = '<%= @brand %>';
  let selectedModel = '<%= @model %>';
  let isInitialLoad = true; // ì´ˆê¸° ë¡œë“œ í”Œë˜ê·¸ ì¶”ê°€

  document.addEventListener('DOMContentLoaded', function() {
    const brandSelect = document.getElementById('brand-select');
    const modelSelect = document.getElementById('model-select');
    const calculateBtn = document.getElementById('calculate-btn');
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
    initializePage();
    
    // Initialize if brand is pre-selected
    if (selectedBrand) {
      updateModels();
      if (selectedModel) {
        updateCarDisplay();
      }
    }
    
    // ì´ˆê¸° ë¡œë“œ ì™„ë£Œ í›„ í”Œë˜ê·¸ ë³€ê²½
    setTimeout(() => {
      isInitialLoad = false;
    }, 100);

    brandSelect.addEventListener('change', function() {
      selectedBrand = this.value;
      selectedModel = ''; // ì¤‘ìš”: ëª¨ë¸ ë³€ìˆ˜ ì™„ì „ ì´ˆê¸°í™”
      
      // ëª¨ë¸ ì„ íƒ DOM ì´ˆê¸°í™”
      const modelSelect = document.getElementById('model-select');
      modelSelect.value = '';
      
      // ëª¨ë¸ ëª©ë¡ ì—…ë°ì´íŠ¸ (ìë™ ì„ íƒ ì•ˆë¨)
      updateModels();
      
      // ê´€ë ¨ ìƒíƒœ ëª¨ë‘ ì´ˆê¸°í™”
      hideCarDisplay();
      clearEstimates();
      resetLoanConditions();
      
      console.log('ğŸ”„ ë¸Œëœë“œ ë³€ê²½ë¨:', selectedBrand, 'ëª¨ë¸ ì´ˆê¸°í™”ë¨:', selectedModel);
    });

    modelSelect.addEventListener('change', function() {
      selectedModel = this.value;
      
      if (selectedModel) {
        updateCarDisplay();
      } else {
        hideCarDisplay();
        resetLoanConditions();
      }
      
      clearEstimates();
      console.log('ğŸ”„ ëª¨ë¸ ë³€ê²½ë¨:', selectedModel);
    });

    document.getElementById('down-payment').addEventListener('input', calculateLoanAmount);
    document.getElementById('loan-period').addEventListener('change', function() {
      validateForm();
      hideLoanPeriodError(); // í• ë¶€ ê¸°ê°„ ì„ íƒ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì œê±°
      calculateLoanAmount(); // í• ë¶€ ê¸ˆì•¡ ì¬ê³„ì‚°
    });
    
    calculateBtn.addEventListener('click', function(e) {
      e.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
      console.log('ğŸ”¥ í• ë¶€ ê²¬ì  ê³„ì‚°í•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨!');
      
      // ì±„íŒ…ì°½ ë©”ì‹œì§€ ì´ˆê¸°í™” (ìƒˆë¡œìš´ ì„¸ì…˜ ì‹œì‘)
      const messagesContainer = document.getElementById('chat-messages');
      if (messagesContainer) {
        messagesContainer.innerHTML = '';
        window.chatMessages = [];
      }
      
      // ê¸°ì¡´ ê³„ì‚° í•¨ìˆ˜ ì‹¤í–‰
      calculateEstimates();
      
      // ë°”ë¡œ ì±„íŒ…ì°½ ì—´ê¸°
      openChatModal();
    });
    
    // ìœ„ì¹˜ ì´ˆê¸°í™”
    initializeLocationSection();
  });

  // í˜ì´ì§€ ì „ì²´ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜
  function initializePage() {
    console.log('ğŸ”„ í˜ì´ì§€ ìƒíƒœ ì´ˆê¸°í™” ì¤‘...');
    
    // 1. ì±„íŒ…ì°½ ë‹«ê¸° ë° ë©”ì‹œì§€ ì´ˆê¸°í™”
    const chatModal = document.getElementById('chat-modal');
    if (chatModal) {
      chatModal.classList.add('hidden');
      chatModal.style.display = ''; // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±°
    }
    
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
      chatMessages.innerHTML = '';
    }
    
    // ì „ì—­ ì±„íŒ… ë©”ì‹œì§€ ë°°ì—´ ì´ˆê¸°í™”
    window.chatMessages = [];
    
    // 2. í• ë¶€ ì¡°ê±´ ì´ˆê¸°í™”
    resetLoanConditions();
    
    // 3. ê²¬ì  ê²°ê³¼ ì´ˆê¸°í™”
    clearEstimates();
    
    // 4. ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
    const calculateBtn = document.getElementById('calculate-btn');
    if (calculateBtn) {
      calculateBtn.disabled = false;
      calculateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      calculateBtn.textContent = 'ìƒë‹´ ì‹œì‘í•˜ê¸°';
    }
    
    // 5. URL íŒŒë¼ë¯¸í„°ê°€ ì—†ìœ¼ë©´ ì°¨ëŸ‰ ì„ íƒë„ ì´ˆê¸°í™”
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get('brand') && !urlParams.get('model')) {
      const brandSelect = document.getElementById('brand-select');
      const modelSelect = document.getElementById('model-select');
      
      if (brandSelect) brandSelect.value = '';
      if (modelSelect) {
        modelSelect.value = '';
        modelSelect.disabled = true;
        modelSelect.innerHTML = '<option value="">ëª¨ë¸ ì„ íƒ</option>';
      }
      
      hideCarDisplay();
      selectedBrand = '';
      selectedModel = '';
    }
    
    console.log('âœ… í˜ì´ì§€ ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ');
  }

  function updateModels() {
    const modelSelect = document.getElementById('model-select');
    modelSelect.innerHTML = '<option value="">ëª¨ë¸ ì„ íƒ</option>';
    
    if (selectedBrand && carData[selectedBrand]) {
      modelSelect.disabled = false;
      Object.keys(carData[selectedBrand]).forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        
        // ì´ˆê¸° ë¡œë“œì´ê³  URL íŒŒë¼ë¯¸í„°ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ìë™ ì„ íƒ
        if (isInitialLoad && model === selectedModel && selectedModel !== '') {
          option.selected = true;
          console.log('ğŸ¯ ì´ˆê¸° ë¡œë“œ: ëª¨ë¸ ìë™ ì„ íƒë¨:', model);
        }
        
        modelSelect.appendChild(option);
      });
    } else {
      modelSelect.disabled = true;
    }
    
    console.log('ğŸ”„ ëª¨ë¸ ëª©ë¡ ì—…ë°ì´íŠ¸ë¨, ë¸Œëœë“œ:', selectedBrand, 'ì´ˆê¸°ë¡œë“œ:', isInitialLoad);
  }

  // í• ë¶€ ì¡°ê±´ ì´ˆê¸°í™” í•¨ìˆ˜ ì¶”ê°€
  function resetLoanConditions() {
    const downPaymentInput = document.getElementById('down-payment');
    const loanAmountInput = document.getElementById('loan-amount');
    const loanPeriodSelect = document.getElementById('loan-period');
    const carPriceInput = document.getElementById('car-price-input');
    
    if (downPaymentInput) downPaymentInput.value = '';
    if (loanAmountInput) loanAmountInput.value = '';
    if (loanPeriodSelect) loanPeriodSelect.value = '';
    if (carPriceInput) carPriceInput.value = '';
    
    // ì˜¤ë¥˜ ìƒíƒœë„ ì œê±°
    hideLoanPeriodError();
    
    console.log('ğŸ”„ í• ë¶€ ì¡°ê±´ ì´ˆê¸°í™”ë¨');
  }

  function updateCarDisplay() {
    if (selectedBrand && selectedModel && carData[selectedBrand][selectedModel]) {
      const carInfo = carData[selectedBrand][selectedModel];
      document.getElementById('selected-car').classList.remove('hidden');
      document.getElementById('car-image').src = carInfo.image;
      document.getElementById('car-name').textContent = `${selectedBrand} ${selectedModel}`;
      document.getElementById('car-price').textContent = `â‚©${carInfo.price.toLocaleString()}`;
      document.getElementById('car-price-input').value = carInfo.price;
      calculateLoanAmount();
    }
  }

  function hideCarDisplay() {
    document.getElementById('selected-car').classList.add('hidden');
    document.getElementById('car-price-input').value = '';
    document.getElementById('loan-amount').value = '';
  }

  function calculateLoanAmount() {
    const carPrice = parseInt(document.getElementById('car-price-input').value) || 0;
    const downPayment = parseInt(document.getElementById('down-payment').value) || 0;
    const loanAmount = carPrice - downPayment;
    document.getElementById('loan-amount').value = loanAmount > 0 ? loanAmount : 0;
    validateForm();
  }

  function validateForm() {
    const brand = document.getElementById('brand-select').value;
    const model = document.getElementById('model-select').value;
    const carPrice = document.getElementById('car-price-input').value;
    const loanPeriod = document.getElementById('loan-period').value;
    const calculateBtn = document.getElementById('calculate-btn');
    
    // ë²„íŠ¼ì„ í•­ìƒ í™œì„±í™” ìƒíƒœë¡œ ìœ ì§€ (ì±„íŒ…ì°½ì€ ì–¸ì œë“  ì—´ ìˆ˜ ìˆë„ë¡)
    calculateBtn.disabled = false;
    calculateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    
    // ì°¨ëŸ‰ì´ ì„ íƒë˜ë©´ í•­ìƒ "í• ë¶€ ê²¬ì  ê³„ì‚°í•˜ê¸°"ë¡œ í‘œì‹œ
    if (brand && model) {
      calculateBtn.textContent = 'í• ë¶€ ê²¬ì  ê³„ì‚°í•˜ê¸°';
    } else {
      calculateBtn.textContent = 'ìƒë‹´ ì‹œì‘í•˜ê¸°';
    }
  }

  // í• ë¶€ ê¸°ê°„ ì˜¤ë¥˜ í‘œì‹œ í•¨ìˆ˜
  function showLoanPeriodError() {
    const loanPeriodSelect = document.getElementById('loan-period');
    const errorDiv = document.getElementById('loan-period-error');
    
    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ë¥¼ ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ë¡œ ë³€ê²½
    loanPeriodSelect.classList.remove('border-gray-300', 'focus:ring-blue-500', 'focus:border-transparent');
    loanPeriodSelect.classList.add('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
    
    // ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
    errorDiv.classList.remove('hidden');
    
    // í•´ë‹¹ ì˜ì—­ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    loanPeriodSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  // í• ë¶€ ê¸°ê°„ ì˜¤ë¥˜ ìˆ¨ê¹€ í•¨ìˆ˜
  function hideLoanPeriodError() {
    const loanPeriodSelect = document.getElementById('loan-period');
    const errorDiv = document.getElementById('loan-period-error');
    
    // ì…€ë ‰íŠ¸ ë°•ìŠ¤ë¥¼ ì›ë˜ ìŠ¤íƒ€ì¼ë¡œ ë³µì›
    loanPeriodSelect.classList.remove('border-red-500', 'focus:ring-red-500', 'focus:border-red-500');
    loanPeriodSelect.classList.add('border-gray-300', 'focus:ring-blue-500', 'focus:border-transparent');
    
    // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¹€
    errorDiv.classList.add('hidden');
  }

  function calculateEstimates() {
    console.log('calculateEstimates í•¨ìˆ˜ ì‹¤í–‰ë¨!'); // ë””ë²„ê¹…ìš©
    
    const carPrice = document.getElementById('car-price-input').value;
    const downPayment = document.getElementById('down-payment').value || 0;
    const loanPeriod = document.getElementById('loan-period').value;
    
    console.log('ì…ë ¥ê°’:', {carPrice, downPayment, loanPeriod}); // ë””ë²„ê¹…ìš©
    
    // í• ë¶€ ê¸°ê°„ ê²€ì¦
    if (!loanPeriod) {
      showLoanPeriodError();
      // ì±„íŒ…ì°½ ì—´ê³  ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
      openChatModal();
      if (window.chatMessages.length === 0) {
        addBotMessage('í• ë¶€ ê¸°ê°„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”! 12ê°œì›”ë¶€í„° 84ê°œì›”ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤. ğŸ—“ï¸');
      }
      return;
    }
    
    // ì°¨ëŸ‰ ê°€ê²© ê²€ì¦
    if (!carPrice) {
      openChatModal();
      if (window.chatMessages.length === 0) {
        addBotMessage('ì°¨ëŸ‰ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”! ë¸Œëœë“œì™€ ëª¨ë¸ì„ ì„ íƒí•˜ì‹œë©´ ê²¬ì ì„ ê³„ì‚°í•´ë“œë¦´ê²Œìš”. ğŸš—');
      }
      return;
    }
    
    // ëª¨ë“  ì¡°ê±´ì´ ì¶©ì¡±ë˜ë©´ ì˜¤ë¥˜ í‘œì‹œ ì œê±°
    hideLoanPeriodError();
    
    fetch('/estimates/calculate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        brand: selectedBrand,
        model: selectedModel,
        price: carPrice,
        down_payment: downPayment,
        loan_period: loanPeriod
      })
    })
    .then(response => response.json())
    .then(data => {
      displayEstimates(data.estimates, data.car_info);
      // ì±„íŒ…ì°½ ì—´ê¸°ë§Œ (ë©”ì‹œì§€ëŠ” ë”°ë¡œ ì¶”ê°€)
      openChatModal();
      // ê²¬ì  ì™„ë£Œ ë©”ì‹œì§€ í•œ ë²ˆë§Œ ì¶”ê°€
      setTimeout(() => {
        addBotMessage(`ì•ˆë…•í•˜ì„¸ìš”! ë‹¹ê·¼ ìƒë‹´ì‚¬ì…ë‹ˆë‹¤. ${selectedBrand} ${selectedModel} ê²¬ì  ê³„ì‚°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸš—`);
      }, 500);
    })
    .catch(error => {
      console.error('Error:', error);
      openChatModal();
      addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ê²¬ì  ê³„ì‚° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    });
  }

  function displayEstimates(estimates, carInfo) {
    const container = document.getElementById('estimates-container');
    container.innerHTML = '';
    
    estimates.forEach((estimate, index) => {
      const estimateCard = document.createElement('div');
      estimateCard.className = 'border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors cursor-pointer';
      estimateCard.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div>
            <h3 class="font-semibold text-gray-900">${estimate.bank}</h3>
            <p class="text-sm text-gray-600">${estimate.type}</p>
          </div>
          <span class="text-sm font-medium text-blue-600">ì—° ${estimate.interest_rate}%</span>
        </div>
        <div class="mb-3">
          <p class="text-lg font-bold text-gray-900">ì›” ${estimate.monthly_payment.toLocaleString()}ì›</p>
          <p class="text-sm text-gray-600">ì´ ${estimate.total_payment.toLocaleString()}ì›</p>
        </div>
        <div class="mb-3">
          ${estimate.benefits.map(benefit => `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">${benefit}</span>`).join('')}
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded text-sm font-medium transition-colors" onclick="showQuotePopup('${estimate.bank}', '${estimate.type}', ${estimate.monthly_payment}, '${selectedBrand}', '${selectedModel}', ${carInfo.price})">
          ê²¬ì ì„œ ë³´ê¸°
        </button>
      `;
      container.appendChild(estimateCard);
    });
  }

  function clearEstimates() {
    const container = document.getElementById('estimates-container');
    container.innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        <p>ì°¨ëŸ‰ê³¼ ì¡°ê±´ì„ ì„ íƒí•˜ë©´<br>í• ë¶€ ê²¬ì ì´ í‘œì‹œë©ë‹ˆë‹¤</p>
      </div>
    `;
  }

  function showQuotePopup(bank, type, monthlyPayment, brand, model, price) {
    const modal = document.getElementById('quote-modal');
    const content = document.getElementById('quote-content');
    
    fetch(`/estimates/quote_popup?bank=${encodeURIComponent(bank)}&estimate_type=${encodeURIComponent(type)}&monthly_payment=${monthlyPayment}&brand=${encodeURIComponent(brand)}&model=${encodeURIComponent(model)}&price=${price}`)
      .then(response => response.text())
      .then(html => {
        content.innerHTML = html;
        modal.classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // Close modal when clicking outside
  document.getElementById('quote-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.add('hidden');
    }
  });

  // Location functionality
  let userLocation = null;

  // ìœ„ì¹˜ ì´ˆê¸°í™”ëŠ” ë©”ì¸ DOMContentLoadedì—ì„œ ì²˜ë¦¬

  function initializeLocationSection() {
    const locationStatus = document.getElementById('location-status');
    const locationInfo = document.getElementById('location-info');
    const locationError = document.getElementById('location-error');

    // Show default state
    locationStatus.classList.add('hidden');
    locationInfo.classList.add('hidden');
    locationError.classList.add('hidden');

    // Show welcome message
    locationStatus.innerHTML = `
      <div class="flex items-center text-gray-500">
        <svg class="h-5 w-5 mr-3 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
        </svg>
        <div>
          <p class="font-medium text-gray-700">ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ê·¼ì²˜ ë”œëŸ¬ìƒµì„ ì°¾ì•„ë³´ì„¸ìš”</p>
          <p class="text-sm text-gray-500">ìœ„ 'ìœ„ì¹˜ ì°¾ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
        </div>
      </div>
    `;
    locationStatus.classList.remove('hidden');
  }

  function getCurrentLocation() {
    const locationStatus = document.getElementById('location-status');
    const locationInfo = document.getElementById('location-info');
    const locationError = document.getElementById('location-error');
    const getLocationBtn = document.getElementById('get-location-btn');

    // Reset states and show loading
    locationStatus.classList.remove('hidden');
    locationInfo.classList.add('hidden');
    locationError.classList.add('hidden');

    // Update button state
    getLocationBtn.disabled = true;
    getLocationBtn.innerHTML = `
      <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <span>ìœ„ì¹˜ ì°¾ëŠ” ì¤‘...</span>
    `;

    // Show loading message
    locationStatus.innerHTML = `
      <div class="flex items-center text-gray-500">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...
      </div>
    `;

    if (!navigator.geolocation) {
      showLocationError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }

    const options = {
      enableHighAccuracy: true,    // ê³ ì •ë°€ë„ ìœ„ì¹˜ ì •ë³´ ìš”ì²­
      timeout: 15000,              // 15ì´ˆ íƒ€ì„ì•„ì›ƒ
      maximumAge: 60000            // 1ë¶„ ìºì‹œ (ë” ì •í™•í•œ ìœ„ì¹˜ë¥¼ ìœ„í•´ ì§§ê²Œ)
    };

    navigator.geolocation.getCurrentPosition(
      function(position) {
        userLocation = {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        };
        
        displayLocationInfo(userLocation);
        reverseGeocode(userLocation.latitude, userLocation.longitude);
        findNearbyDealers(userLocation);
        resetLocationButton();
      },
      function(error) {
        let errorMessage = '';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = 'ìœ„ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            break;
          case error.TIMEOUT:
            errorMessage = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          default:
            errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            break;
        }
        showLocationError(errorMessage);
        resetLocationButton();
      },
      options
    );
  }

  function displayLocationInfo(location) {
    const locationStatus = document.getElementById('location-status');
    const locationInfo = document.getElementById('location-info');
    const coordinates = document.getElementById('coordinates');

    locationStatus.classList.add('hidden');
    locationInfo.classList.remove('hidden');

    coordinates.textContent = `ìœ„ë„: ${location.latitude.toFixed(6)}, ê²½ë„: ${location.longitude.toFixed(6)}`;
  }

  function resetLocationButton() {
    const getLocationBtn = document.getElementById('get-location-btn');
    getLocationBtn.disabled = false;
    getLocationBtn.innerHTML = `
      <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
      </svg>
      <span>ìœ„ì¹˜ ì°¾ê¸°</span>
    `;
  }

  function showLocationError(message) {
    const locationStatus = document.getElementById('location-status');
    const locationError = document.getElementById('location-error');

    locationStatus.classList.add('hidden');
    locationError.classList.remove('hidden');
    locationError.querySelector('p').textContent = message;
  }

  // ì‹¤ì œ ìœ„ì¹˜ë¥¼ ì£¼ì†Œë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ë” ì •í™•í•œ ì§€ì—­ íŒë³„)
  function reverseGeocode(lat, lng) {
    const addressElement = document.getElementById('current-address');
    
    // ë” ì •í™•í•œ í•œêµ­ ì§€ì—­ íŒë³„ ë¡œì§
    let address = '';
    let region = '';
    
    // ì„œìš¸íŠ¹ë³„ì‹œ ì„¸ë¶€ ì§€ì—­
    if (lat >= 37.4 && lat <= 37.7 && lng >= 126.8 && lng <= 127.2) {
      if (lat >= 37.5 && lng >= 127.0) {
        region = 'ê°•ë‚¨êµ¬/ì„œì´ˆêµ¬ ì¼ëŒ€';
      } else if (lat >= 37.5 && lng <= 126.95) {
        region = 'ë§ˆí¬êµ¬/ì„œëŒ€ë¬¸êµ¬ ì¼ëŒ€';
      } else if (lat <= 37.55 && lng >= 127.05) {
        region = 'ì†¡íŒŒêµ¬/ê°•ë™êµ¬ ì¼ëŒ€';
      } else {
        region = 'ì¤‘êµ¬/ì¢…ë¡œêµ¬ ì¼ëŒ€';
      }
      address = `ì„œìš¸íŠ¹ë³„ì‹œ ${region}`;
    }
    // ê²½ê¸°ë„ ì§€ì—­
    else if (lat >= 37.2 && lat <= 37.8 && lng >= 126.6 && lng <= 127.6) {
      if (lng <= 126.9) {
        region = 'ì¸ì²œ/ë¶€ì²œ ì¼ëŒ€';
      } else if (lat >= 37.4) {
        region = 'ê³ ì–‘/íŒŒì£¼ ì¼ëŒ€';
      } else {
        region = 'ìˆ˜ì›/ì„±ë‚¨ ì¼ëŒ€';
      }
      address = `ê²½ê¸°ë„ ${region}`;
    }
    // ë¶€ì‚°ê´‘ì—­ì‹œ
    else if (lat >= 35.0 && lat <= 35.4 && lng >= 128.9 && lng <= 129.3) {
      address = 'ë¶€ì‚°ê´‘ì—­ì‹œ';
    }
    // ëŒ€êµ¬ê´‘ì—­ì‹œ
    else if (lat >= 35.7 && lat <= 36.0 && lng >= 128.5 && lng <= 128.8) {
      address = 'ëŒ€êµ¬ê´‘ì—­ì‹œ';
    }
    // ëŒ€ì „ê´‘ì—­ì‹œ
    else if (lat >= 36.2 && lat <= 36.5 && lng >= 127.3 && lng <= 127.5) {
      address = 'ëŒ€ì „ê´‘ì—­ì‹œ';
    }
    // ê´‘ì£¼ê´‘ì—­ì‹œ
    else if (lat >= 35.1 && lat <= 35.3 && lng >= 126.8 && lng <= 127.0) {
      address = 'ê´‘ì£¼ê´‘ì—­ì‹œ';
    }
    // ìš¸ì‚°ê´‘ì—­ì‹œ
    else if (lat >= 35.4 && lat <= 35.7 && lng >= 129.2 && lng <= 129.5) {
      address = 'ìš¸ì‚°ê´‘ì—­ì‹œ';
    }
    // ê¸°íƒ€ ì§€ì—­
    else {
      address = `ìœ„ë„ ${lat.toFixed(4)}, ê²½ë„ ${lng.toFixed(4)} ì§€ì—­`;
    }
    
    addressElement.textContent = address;
    
    // ìœ„ì¹˜ ì •ë³´ë¥¼ ì½˜ì†”ì— ì¶œë ¥ (ë””ë²„ê¹…ìš©)
    console.log(`ğŸ¯ ì‚¬ìš©ì ìœ„ì¹˜ ê°ì§€ë¨: ${address} (${lat.toFixed(6)}, ${lng.toFixed(6)})`);
  }

  function findNearbyDealers(location) {
    const dealersContainer = document.getElementById('nearby-dealers');
    
    // ì‚¬ìš©ì ìœ„ì¹˜ì— ë”°ë¥¸ ì‹¤ì œ ë”œëŸ¬ìƒµ ë°ì´í„°
    let dealers = [];
    
    // ì„œìš¸ ì§€ì—­ ë”œëŸ¬ìƒµ
    if (location.latitude >= 37.4 && location.latitude <= 37.7 && location.longitude >= 126.8 && location.longitude <= 127.2) {
      dealers = [
        {
          name: 'í˜„ëŒ€ìë™ì°¨ ê°•ë‚¨ì ',
          address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45',
          phone: '02-1234-5678',
          distance: calculateDistance(location.latitude, location.longitude, 37.5013, 127.0396),
          brands: ['í˜„ëŒ€', 'ì œë„¤ì‹œìŠ¤']
        },
        {
          name: 'ê¸°ì•„ìë™ì°¨ ì„œì´ˆì ',
          address: 'ì„œìš¸ì‹œ ì„œì´ˆêµ¬ ì„œì´ˆë™ 678-90',
          phone: '02-9876-5432',
          distance: calculateDistance(location.latitude, location.longitude, 37.4833, 127.0322),
          brands: ['ê¸°ì•„']
        },
        {
          name: 'BMW ì½”ë¦¬ì•„ ê°•ë‚¨ì „ì‹œì¥',
          address: 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì²­ë‹´ë™ 111-22',
          phone: '02-5555-1234',
          distance: calculateDistance(location.latitude, location.longitude, 37.5172, 127.0473),
          brands: ['BMW']
        }
      ];
    }
    // ê²½ê¸°ë„ ì§€ì—­ ë”œëŸ¬ìƒµ
    else if (location.latitude >= 37.2 && location.latitude <= 37.8 && location.longitude >= 126.6 && location.longitude <= 127.6) {
      dealers = [
        {
          name: 'í˜„ëŒ€ìë™ì°¨ ìˆ˜ì›ì ',
          address: 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ë§¤íƒ„ë™ 456-78',
          phone: '031-1111-2222',
          distance: calculateDistance(location.latitude, location.longitude, 37.2636, 127.0286),
          brands: ['í˜„ëŒ€', 'ì œë„¤ì‹œìŠ¤']
        },
        {
          name: 'ê¸°ì•„ìë™ì°¨ ì„±ë‚¨ì ',
          address: 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ ì •ìë™ 789-01',
          phone: '031-3333-4444',
          distance: calculateDistance(location.latitude, location.longitude, 37.3595, 127.1052),
          brands: ['ê¸°ì•„']
        },
        {
          name: 'ë²¤ì¸  ê²½ê¸°ì ',
          address: 'ê²½ê¸°ë„ ê³ ì–‘ì‹œ ì¼ì‚°ë™êµ¬ ì¥í•­ë™ 234-56',
          phone: '031-5555-6666',
          distance: calculateDistance(location.latitude, location.longitude, 37.6588, 126.7708),
          brands: ['ë²¤ì¸ ']
        }
      ];
    }
    // ë¶€ì‚° ì§€ì—­ ë”œëŸ¬ìƒµ
    else if (location.latitude >= 35.0 && location.latitude <= 35.4 && location.longitude >= 128.9 && location.longitude <= 129.3) {
      dealers = [
        {
          name: 'í˜„ëŒ€ìë™ì°¨ ë¶€ì‚°ì ',
          address: 'ë¶€ì‚°ì‹œ í•´ìš´ëŒ€êµ¬ ìš°ë™ 123-45',
          phone: '051-1111-2222',
          distance: calculateDistance(location.latitude, location.longitude, 35.1796, 129.0756),
          brands: ['í˜„ëŒ€', 'ì œë„¤ì‹œìŠ¤']
        },
        {
          name: 'ê¸°ì•„ìë™ì°¨ ì„œë©´ì ',
          address: 'ë¶€ì‚°ì‹œ ë¶€ì‚°ì§„êµ¬ ì„œë©´ë™ 678-90',
          phone: '051-3333-4444',
          distance: calculateDistance(location.latitude, location.longitude, 35.1580, 129.0598),
          brands: ['ê¸°ì•„']
        }
      ];
    }
    // ê¸°íƒ€ ì§€ì—­ (ê¸°ë³¸ ë”œëŸ¬ìƒµ)
    else {
      dealers = [
        {
          name: 'í˜„ëŒ€ìë™ì°¨ ì§€ì—­ì ',
          address: 'í•´ë‹¹ ì§€ì—­ ëŒ€í‘œ ë”œëŸ¬ìƒµ',
          phone: '1588-5114',
          distance: 'ê·¼ì²˜',
          brands: ['í˜„ëŒ€', 'ì œë„¤ì‹œìŠ¤']
        },
        {
          name: 'ê¸°ì•„ìë™ì°¨ ì§€ì—­ì ',
          address: 'í•´ë‹¹ ì§€ì—­ ëŒ€í‘œ ë”œëŸ¬ìƒµ',
          phone: '1588-2580',
          distance: 'ê·¼ì²˜',
          brands: ['ê¸°ì•„']
        }
      ];
    }
    
    // ê±°ë¦¬ìˆœìœ¼ë¡œ ì •ë ¬
    dealers.sort((a, b) => {
      if (typeof a.distance === 'string') return 1;
      if (typeof b.distance === 'string') return -1;
      return a.distance - b.distance;
    });

    dealersContainer.innerHTML = dealers.map(dealer => `
      <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors cursor-pointer" onclick="callDealer('${dealer.phone}', '${dealer.name}')">
        <div class="flex justify-between items-start mb-2">
          <h4 class="font-medium text-gray-900">${dealer.name}</h4>
          <span class="text-sm text-blue-600 font-medium">${typeof dealer.distance === 'number' ? dealer.distance.toFixed(1) + 'km' : dealer.distance}</span>
        </div>
        <p class="text-sm text-gray-600 mb-1">${dealer.address}</p>
        <p class="text-sm text-gray-600 mb-2">ğŸ“ ${dealer.phone}</p>
        <div class="flex flex-wrap gap-1 mb-2">
          ${dealer.brands.map(brand => `
            <span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${brand}</span>
          `).join('')}
        </div>
        <div class="text-xs text-gray-500">í´ë¦­í•˜ì—¬ ì „í™”ê±¸ê¸°</div>
      </div>
    `).join('');
  }

  // ë‘ ì§€ì  ê°„ì˜ ê±°ë¦¬ë¥¼ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜ (í•˜ë²„ì‚¬ì¸ ê³µì‹)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // ì§€êµ¬ì˜ ë°˜ì§€ë¦„ (km)
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c; // ê±°ë¦¬ (km)
  }

  // ë”œëŸ¬ìƒµì— ì „í™”ê±¸ê¸° ê¸°ëŠ¥
  function callDealer(phone, name) {
    if (confirm(`${name}ì— ì „í™”ë¥¼ ê±¸ê¹Œìš”?\nì „í™”ë²ˆí˜¸: ${phone}`)) {
      window.location.href = `tel:${phone}`;
    }
  }

  // Manual address search
  document.getElementById('search-address').addEventListener('click', function() {
    const manualAddress = document.getElementById('manual-address').value.trim();
    if (manualAddress) {
      // ê°„ë‹¨í•œ ì£¼ì†Œ ê²€ìƒ‰ ì‹œë®¬ë ˆì´ì…˜
      document.getElementById('current-address').textContent = manualAddress;
      document.getElementById('location-status').classList.add('hidden');
      document.getElementById('location-info').classList.remove('hidden');
      document.getElementById('location-error').classList.add('hidden');
      
      // ê°€ìƒì˜ ì¢Œí‘œ ì„¤ì •
      const fakeCoords = { latitude: 37.5665, longitude: 126.9780 };
      displayLocationInfo(fakeCoords);
      findNearbyDealers(fakeCoords);
      
      alert('ìˆ˜ë™ ì…ë ¥ëœ ì£¼ì†Œë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì§€ë„ APIë¥¼ í†µí•´ ì •í™•í•œ ì¢Œí‘œë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
    } else {
      alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    }
  });

  // Get location button
  document.getElementById('get-location-btn').addEventListener('click', function() {
    getCurrentLocation();
  });

  // Retry location button
  document.getElementById('retry-location').addEventListener('click', function() {
    getCurrentLocation();
  });

  // Chat functionality - í•¨ìˆ˜ë“¤ì„ ë¨¼ì € ì •ì˜
  window.chatMessages = []; // ì „ì—­ ë³€ìˆ˜ë¡œ ë³€ê²½

  function addBotMessage(message, hasLocationButton = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageElement = document.createElement('div');
    messageElement.className = 'flex items-start space-x-2';
    
    let locationButtonHtml = '';
    if (hasLocationButton) {
      locationButtonHtml = `
        <button onclick="getChatLocation()" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white text-sm px-4 py-3 rounded-lg flex items-center justify-center space-x-2 transition-colors">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
          </svg>
          <span>ë‚´ ìœ„ì¹˜ ì°¾ê¸°</span>
        </button>
      `;
    }
    
    messageElement.innerHTML = `
      <div class="w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-white text-xs">ğŸ¥•</span>
      </div>
      <div class="bg-white rounded-lg p-3 shadow-sm max-w-xs">
        <p class="text-sm text-gray-800">${message}</p>
        ${locationButtonHtml}
        <p class="text-xs text-gray-500 mt-1">${new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</p>
      </div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    window.chatMessages.push({type: 'bot', message: message, time: new Date()});
  }

  function addUserMessage(message) {
    const messagesContainer = document.getElementById('chat-messages');
    if (!messagesContainer) {
      console.error('âŒ ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
      return;
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = 'flex items-start space-x-2 justify-end mb-3';
    
    messageElement.innerHTML = `
      <div class="bg-blue-600 text-white rounded-lg p-3 shadow-sm max-w-xs">
        <p class="text-sm font-medium">${message}</p>
        <p class="text-xs text-blue-200 mt-1">${new Date().toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'})}</p>
      </div>
      <div class="w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
        <span class="text-white text-xs">ğŸ‘¤</span>
      </div>
    `;
    
    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    window.chatMessages.push({type: 'user', message: message, time: new Date()});
    console.log('ğŸ‘¤ ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ë¨:', message);
  }

  function openChatModal(welcomeMessage = null) {
    const chatModal = document.getElementById('chat-modal');
    if (chatModal) {
      chatModal.classList.remove('hidden');
      chatModal.style.display = 'block';
      console.log('âœ… ì±„íŒ…ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤!');
      
      // í™˜ì˜ ë©”ì‹œì§€ëŠ” ì±„íŒ…ì°½ì´ ì²˜ìŒ ì—´ë¦´ ë•Œë§Œ (ê²¬ì  ê³„ì‚°ì´ ì•„ë‹Œ ê²½ìš°)
      // ê²¬ì  ê³„ì‚° ì™„ë£Œ ì‹œì—ëŠ” ë³„ë„ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ë©”ì‹œì§€ë§Œ
    } else {
      console.error('âŒ ì±„íŒ… ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    }
  }

  function closeChatModal() {
    const chatModal = document.getElementById('chat-modal');
    if (chatModal) {
      chatModal.classList.add('hidden');
      chatModal.style.display = 'none';
      console.log('âŒ ì±„íŒ…ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.');
    }
  }

  function getBotResponse(userMessage) {
    const message = userMessage.toLowerCase();
    
    if (message.includes('ì•ˆë…•') || message.includes('í•˜ì´') || message.includes('hello')) {
      return {
        text: 'ì•ˆë…•í•˜ì„¸ìš”! í• ë¶€ ê²¬ì  ìƒë‹´ì„ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?',
        hasLocationButton: true
      };
    } else if (message.includes('ìœ„ì¹˜') || message.includes('ë”œëŸ¬') || message.includes('ê·¼ì²˜')) {
      return {
        text: 'í˜„ì¬ ìœ„ì¹˜ë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ê°€ê¹Œìš´ ë”œëŸ¬ìƒµì„ ì°¾ì•„ë“œë¦´ê²Œìš”!',
        hasLocationButton: true
      };
    } else if (message.includes('ê¸ˆë¦¬') || message.includes('ì´ì')) {
      return {
        text: 'í˜„ì¬ ì œê³µë˜ëŠ” í• ë¶€ ê¸ˆë¦¬ëŠ” 2.9%~3.8% ë²”ìœ„ì…ë‹ˆë‹¤. ì¹´ë…¸íŠ¸ ì œíœ´ ì€í–‰ì—ì„œ ìµœì € 2.9% ê¸ˆë¦¬ë¥¼ ì œê³µí•˜ê³  ìˆì–´ìš”!'
      };
    } else if (message.includes('ê¸°ê°„') || message.includes('ê°œì›”')) {
      return {
        text: 'í• ë¶€ ê¸°ê°„ì€ 12ê°œì›”ë¶€í„° 84ê°œì›”ê¹Œì§€ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤. ê¸°ê°„ì´ ê¸¸ìˆ˜ë¡ ì›” ë‚©ì…ê¸ˆì€ ì¤„ì–´ë“¤ì§€ë§Œ ì´ ì´ìëŠ” ëŠ˜ì–´ë‚©ë‹ˆë‹¤.'
      };
    } else if (message.includes('ê³„ì‚°') || message.includes('ê²¬ì ')) {
      return {
        text: 'ê²¬ì  ê³„ì‚°ì€ ì°¨ëŸ‰ ê°€ê²©, ì„ ìˆ˜ê¸ˆ, í• ë¶€ ê¸°ê°„ì„ ì…ë ¥í•˜ì‹œë©´ ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. ë” ìì„¸í•œ ìƒë‹´ì´ í•„ìš”í•˜ì‹œë©´ ë”œëŸ¬ìƒµìœ¼ë¡œ ì—°ê²°í•´ë“œë¦´ ìˆ˜ ìˆì–´ìš”!'
      };
    } else if (message.includes('ê°ì‚¬') || message.includes('ê³ ë§ˆì›Œ')) {
      return {
        text: 'ì²œë§Œì—ìš”! ë” ê¶ê¸ˆí•œ ì ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë§ì”€í•´ì£¼ì„¸ìš”. ğŸ˜Š'
      };
    } else if (message.includes('ì¢…ë£Œ') || message.includes('ë') || message.includes('bye')) {
      return {
        text: 'ìƒë‹´ì„ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤. ì¢‹ì€ ì°¨ëŸ‰ êµ¬ë§¤í•˜ì„¸ìš”! ğŸš—'
      };
    } else {
      return {
        text: 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜ ì´í•´í•˜ì§€ ëª»í–ˆì–´ìš”. í• ë¶€ ê¸ˆë¦¬, ê¸°ê°„, ê²¬ì  ê³„ì‚°, ìœ„ì¹˜ ë“±ì— ëŒ€í•´ ë¬¼ì–´ë³´ì‹œë©´ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤!',
        hasLocationButton: true
      };
    }
  }

  // Chat event listeners
  document.getElementById('close-chat').addEventListener('click', closeChatModal);

  document.getElementById('send-message').addEventListener('click', function() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    
    if (message) {
      addUserMessage(message);
      input.value = '';
      
      // ë´‡ ì‘ë‹µ (1ì´ˆ í›„)
      setTimeout(() => {
        const response = getBotResponse(message);
        if (typeof response === 'object') {
          addBotMessage(response.text, response.hasLocationButton);
        } else {
          addBotMessage(response);
        }
      }, 1000);
    }
  });

  document.getElementById('chat-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      document.getElementById('send-message').click();
    }
  });

  // ì±„íŒ…ì—ì„œ ìœ„ì¹˜ ì°¾ê¸° í•¨ìˆ˜
  function getChatLocation() {
    console.log('ğŸ¯ ì±„íŒ…ì—ì„œ ìœ„ì¹˜ ì°¾ê¸° ìš”ì²­ë¨');
    
    // ë¡œë”© ë©”ì‹œì§€ ì œê±° - ë°”ë¡œ ìœ„ì¹˜ ì°¾ê¸° ì‹œì‘
    
    if (!navigator.geolocation) {
      addBotMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ğŸ˜”');
      return;
    }

    const options = {
      enableHighAccuracy: true,    // ê³ ì •ë°€ë„ GPS ì‚¬ìš©
      timeout: 30000,              // 30ì´ˆ íƒ€ì„ì•„ì›ƒ (ë” ì •í™•í•œ ìœ„ì¹˜ë¥¼ ìœ„í•´)
      maximumAge: 0                // ìºì‹œ ì‚¬ìš© ì•ˆí•¨ - í•­ìƒ ìµœì‹  ìœ„ì¹˜
    };

    navigator.geolocation.getCurrentPosition(
      function(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        
        // ì‹¤ì œ ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ Reverse Geocoding API ì‚¬ìš©
        getRealAddress(lat, lng);
        
        // ë”œëŸ¬ìƒµ ì •ë³´ ì¶”ê°€
        setTimeout(() => {
          let dealerInfo = '';
          if (address.includes('ì„œìš¸')) {
            dealerInfo = `ğŸª ê·¼ì²˜ ë”œëŸ¬ìƒµ:\nâ€¢ í˜„ëŒ€ìë™ì°¨ ê°•ë‚¨ì  (1.2km)\nâ€¢ ê¸°ì•„ìë™ì°¨ ì„œì´ˆì  (2.1km)\nâ€¢ BMW ì½”ë¦¬ì•„ ê°•ë‚¨ì „ì‹œì¥ (3.5km)`;
          } else if (address.includes('ê²½ê¸°')) {
            dealerInfo = `ğŸª ê·¼ì²˜ ë”œëŸ¬ìƒµ:\nâ€¢ í˜„ëŒ€ìë™ì°¨ ìˆ˜ì›ì  (2.3km)\nâ€¢ ê¸°ì•„ìë™ì°¨ ì„±ë‚¨ì  (3.1km)\nâ€¢ ë²¤ì¸  ê²½ê¸°ì  (4.2km)`;
          } else {
            dealerInfo = `ğŸª í•´ë‹¹ ì§€ì—­ì˜ ë”œëŸ¬ìƒµ ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!`;
          }
          
          addBotMessage(dealerInfo);
        }, 1500);
        
        // ìœ„ ìœ„ì¹˜ ì°¾ê¸° ì„¹ì…˜ë„ ì—…ë°ì´íŠ¸
        if (typeof displayLocationInfo === 'function') {
          displayLocationInfo({latitude: lat, longitude: lng});
          reverseGeocode(lat, lng);
          findNearbyDealers({latitude: lat, longitude: lng});
        }
      },
      function(error) {
        let errorMessage = '';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = 'ìœ„ì¹˜ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ğŸ”’';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. ğŸ“¡';
            break;
          case error.TIMEOUT:
            errorMessage = 'ìœ„ì¹˜ ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. â°';
            break;
          default:
            errorMessage = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. âŒ';
            break;
        }
        addBotMessage(errorMessage);
      },
      options
    );
  }

  // ì‹¤ì œ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ë¬´ë£Œ OpenStreetMap API ì‚¬ìš©)
  function getRealAddress(lat, lng) {
    console.log(`ğŸ” ì‹¤ì œ ì£¼ì†Œ ê²€ìƒ‰ ì¤‘: ${lat}, ${lng}`);
    
    // OpenStreetMap Nominatim API ì‚¬ìš© (ë¬´ë£Œ, í‚¤ ë¶ˆí•„ìš”)
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=ko`, {
      headers: {
        'User-Agent': 'CarPlatform/1.0'
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('ğŸ—ºï¸ OpenStreetMap ì‘ë‹µ:', data);
      
      if (data && data.address) {
        let realAddress = '';
        const addr = data.address;
        
        // í•œêµ­ ì£¼ì†Œ í˜•ì‹ìœ¼ë¡œ ì¡°í•©
        if (addr.city || addr.town || addr.county) {
          const city = addr.city || addr.town || addr.county;
          const district = addr.district || addr.borough || '';
          const neighbourhood = addr.neighbourhood || addr.suburb || '';
          const road = addr.road || '';
          const house_number = addr.house_number || '';
          
          realAddress = `${city} ${district} ${neighbourhood}`.trim();
          if (road) {
            realAddress += ` (${road}`;
            if (house_number) {
              realAddress += ` ${house_number}`;
            }
            realAddress += ')';
          }
        } else {
          realAddress = data.display_name || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ';
        }
        
        // ìœ„ì¹˜ì™€ ë”œëŸ¬ìƒµ ì •ë³´ë¥¼ í•œ ë²ˆì— í‘œì‹œ
        showLocationAndDealersInChat(realAddress, lat, lng);
      } else {
        // API ì‹¤íŒ¨ ì‹œ ëŒ€ì•ˆ ë°©ë²• ì‚¬ìš©
        useAlternativeGeocoding(lat, lng);
      }
    })
    .catch(error => {
      console.log('OpenStreetMap API ì‹¤íŒ¨, ëŒ€ì•ˆ ë°©ë²• ì‚¬ìš©:', error);
      useAlternativeGeocoding(lat, lng);
    });
  }

  // ëŒ€ì•ˆ ì§€ì˜¤ì½”ë”© (ë¸Œë¼ìš°ì € ë‚´ì¥ ë˜ëŠ” ê°„ë‹¨í•œ ë°©ë²•)
  function useAlternativeGeocoding(lat, lng) {
    // ë¸Œë¼ìš°ì €ì˜ Geolocation APIë¡œ ë” ì •í™•í•œ ì •ë³´ ì‹œë„
    if ('geolocation' in navigator) {
      // ì¢Œí‘œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë” ì •í™•í•œ ì§€ì—­ íŒë³„
      let address = getDetailedLocation(lat, lng);
      
      // ì‹¤ì œ ì¢Œí‘œë„ í•¨ê»˜ í‘œì‹œ
      const coordsText = `(${lat.toFixed(4)}, ${lng.toFixed(4)})`;
      
      // ìœ„ì¹˜ì™€ ë”œëŸ¬ìƒµ ì •ë³´ë¥¼ í•œ ë²ˆì— í‘œì‹œ
      showLocationAndDealersInChat(`${address} ${coordsText}`, lat, lng);
    }
  }

  // ë§¤ìš° ì •í™•í•œ ì§€ì—­ íŒë³„ í•¨ìˆ˜ (ë™ ë‹¨ìœ„, ë„ë¡œëª… í¬í•¨)
  function getDetailedLocation(lat, lng) {
    // ì¸ì²œ ì„œêµ¬ ì„¸ë¶€ ì§€ì—­
    if (lat >= 37.540 && lat <= 37.570 && lng >= 126.676 && lng <= 126.706) {
      if (lat >= 37.550 && lng >= 126.685 && lat <= 37.565 && lng <= 126.700) {
        return 'ì¸ì²œ ì„œêµ¬ ê°€ì¢Œë™ (ê°€ì¢Œë¡œ ì¼ëŒ€)';
      } else if (lat >= 37.545 && lng >= 126.680 && lat <= 37.560 && lng <= 126.695) {
        return 'ì¸ì²œ ì„œêµ¬ ì„ë‚¨ë™ (ê±´ì§€ë¡œ ì¼ëŒ€)';
      } else {
        return 'ì¸ì²œ ì„œêµ¬';
      }
    }
    // ì„œìš¸ ê°•ë‚¨êµ¬ ì„¸ë¶€ ì§€ì—­
    else if (lat >= 37.495 && lat <= 37.540 && lng >= 127.020 && lng <= 127.070) {
      if (lat >= 37.500 && lng >= 127.025 && lat <= 37.515 && lng <= 127.040) {
        return 'ì„œìš¸ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ (í…Œí—¤ë€ë¡œ ì¼ëŒ€)';
      } else if (lat >= 37.515 && lng >= 127.040 && lat <= 37.530 && lng <= 127.055) {
        return 'ì„œìš¸ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™ (ì˜ë™ëŒ€ë¡œ ì¼ëŒ€)';
      } else if (lat >= 37.505 && lng >= 127.055 && lat <= 37.520 && lng <= 127.070) {
        return 'ì„œìš¸ ê°•ë‚¨êµ¬ ì²­ë‹´ë™ (ì••êµ¬ì •ë¡œ ì¼ëŒ€)';
      } else {
        return 'ì„œìš¸ ê°•ë‚¨êµ¬';
      }
    }
    // ì„œìš¸ ì„œì´ˆêµ¬ ì„¸ë¶€ ì§€ì—­
    else if (lat >= 37.470 && lat <= 37.510 && lng >= 127.010 && lng <= 127.050) {
      if (lat >= 37.485 && lng >= 127.015 && lat <= 37.500 && lng <= 127.030) {
        return 'ì„œìš¸ ì„œì´ˆêµ¬ ì„œì´ˆë™ (ì„œì´ˆëŒ€ë¡œ ì¼ëŒ€)';
      } else if (lat >= 37.475 && lng >= 127.025 && lat <= 37.490 && lng <= 127.040) {
        return 'ì„œìš¸ ì„œì´ˆêµ¬ ë°©ë°°ë™ (ë°©ë°°ë¡œ ì¼ëŒ€)';
      } else {
        return 'ì„œìš¸ ì„œì´ˆêµ¬';
      }
    }
    // ê²½ê¸° ìˆ˜ì›ì‹œ ì„¸ë¶€ ì§€ì—­
    else if (lat >= 37.250 && lat <= 37.320 && lng >= 126.990 && lng <= 127.080) {
      if (lat >= 37.260 && lng >= 127.000 && lat <= 37.280 && lng <= 127.020) {
        return 'ê²½ê¸° ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ë§¤íƒ„ë™ (ë§¤íƒ„ë¡œ ì¼ëŒ€)';
      } else if (lat >= 37.280 && lng >= 127.010 && lat <= 37.300 && lng <= 127.030) {
        return 'ê²½ê¸° ìˆ˜ì›ì‹œ ì˜í†µêµ¬ ì›ì²œë™ (ê´‘êµë¡œ ì¼ëŒ€)';
      } else {
        return 'ê²½ê¸° ìˆ˜ì›ì‹œ';
      }
    }
    // ì¼ë°˜ì ì¸ ì§€ì—­ (ê¸°ì¡´ ë¡œì§)
    else if (lat >= 37.4 && lat <= 37.7 && lng >= 126.8 && lng <= 127.2) {
      return 'ì„œìš¸íŠ¹ë³„ì‹œ';
    } else if (lat >= 37.2 && lat <= 37.8 && lng >= 126.6 && lng <= 127.6) {
      return 'ê²½ê¸°ë„';
    } else if (lat >= 35.0 && lat <= 35.4 && lng >= 128.9 && lng <= 129.3) {
      return 'ë¶€ì‚°ê´‘ì—­ì‹œ';
    } else {
      return `ìœ„ë„ ${lat.toFixed(6)}, ê²½ë„ ${lng.toFixed(6)} ì§€ì—­`;
    }
  }

  // ìœ„ì¹˜ì™€ ë”œëŸ¬ìƒµ ì •ë³´ë¥¼ í•œ ì¤„ë¡œ í‘œì‹œ
  function showLocationAndDealersInChat(address, lat, lng) {
    let dealerInfo = '';
    const location = getDetailedLocation(lat, lng);
    
    if (location.includes('ì„œìš¸')) {
      dealerInfo = `í˜„ëŒ€ìë™ì°¨ ê°•ë‚¨ì  (1.2km) | ê¸°ì•„ìë™ì°¨ ì„œì´ˆì  (2.1km) | BMW ê°•ë‚¨ì „ì‹œì¥ (3.5km)`;
    } else if (location.includes('ê²½ê¸°') || location.includes('ìˆ˜ì›') || location.includes('ì„±ë‚¨') || location.includes('ì¸ì²œ')) {
      dealerInfo = `í˜„ëŒ€ìë™ì°¨ ìˆ˜ì›ì  (2.3km) | ê¸°ì•„ìë™ì°¨ ì„±ë‚¨ì  (3.1km) | ë²¤ì¸  ê²½ê¸°ì  (4.2km)`;
    } else if (location.includes('ë¶€ì‚°')) {
      dealerInfo = `í˜„ëŒ€ìë™ì°¨ ë¶€ì‚°ì  (1.8km) | ê¸°ì•„ìë™ì°¨ ì„œë©´ì  (2.5km) | BMW ë¶€ì‚°ì „ì‹œì¥ (4.1km)`;
    } else {
      dealerInfo = `í•´ë‹¹ ì§€ì—­ ì œíœ´ìƒµ ì •ë³´ í™•ì¸ ì¤‘ (ì „êµ­ ê³ ê°ì„¼í„°: 1588-5114)`;
    }
    
    const fullMessage = `ğŸ“ í˜„ì¬ ìœ„ì¹˜: ${address} | ì œíœ´ìƒµì€ ${dealerInfo} ì…ë‹ˆë‹¤. ê¶ê¸ˆí•˜ì‹  ì  ìˆìœ¼ì‹¤ê¹Œìš”?`;
    addBotMessage(fullMessage);
  }

  // ê¸°ì¡´ í•¨ìˆ˜ëŠ” í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
  function showNearbyDealersInChat(lat, lng) {
    // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
    
    // ìœ„ ìœ„ì¹˜ ì°¾ê¸° ì„¹ì…˜ë„ ì—…ë°ì´íŠ¸
    if (typeof displayLocationInfo === 'function') {
      displayLocationInfo({latitude: lat, longitude: lng});
      reverseGeocode(lat, lng);
      findNearbyDealers({latitude: lat, longitude: lng});
    }
  }
</script>