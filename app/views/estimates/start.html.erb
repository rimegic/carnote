<!-- Estimate Start Page -->
<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <div class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">신차 할부 견적</h1>
          <p class="text-gray-600 mt-1">최적의 할부 조건을 비교해보세요</p>
        </div>
        <%= link_to "← 홈으로", root_path, class: "text-blue-600 hover:text-blue-700 font-medium" %>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Left: Car Selection -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">차량 선택</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">브랜드</label>
              <select id="brand-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">브랜드 선택</option>
                <option value="현대" <%= 'selected' if @brand == '현대' %>>현대</option>
                <option value="기아" <%= 'selected' if @brand == '기아' %>>기아</option>
                <option value="제네시스" <%= 'selected' if @brand == '제네시스' %>>제네시스</option>
                <option value="BMW" <%= 'selected' if @brand == 'BMW' %>>BMW</option>
                <option value="벤츠" <%= 'selected' if @brand == '벤츠' %>>벤츠</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">모델</label>
              <select id="model-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" <%= 'disabled' unless @brand %>>
                <option value="">모델 선택</option>
              </select>
            </div>
          </div>

          <!-- Selected Car Display -->
          <div id="selected-car" class="hidden">
            <div class="border border-gray-200 rounded-lg p-4 bg-blue-50">
              <div class="flex items-center space-x-4">
                <img id="car-image" src="" alt="" class="w-20 h-16 object-cover rounded-lg">
                <div>
                  <h3 id="car-name" class="text-lg font-semibold text-gray-900"></h3>
                  <p id="car-price" class="text-xl font-bold text-blue-600"></p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Loan Conditions -->
        <div class="bg-white rounded-xl shadow-sm p-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">할부 조건</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">차량 가격</label>
              <input type="number" id="car-price-input" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="차량 가격" readonly>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">선수금</label>
              <input type="number" id="down-payment" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="선수금 입력">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">할부 기간</label>
              <select id="loan-period" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">기간 선택</option>
                <option value="12">12개월</option>
                <option value="24">24개월</option>
                <option value="36">36개월</option>
                <option value="48">48개월</option>
                <option value="60">60개월</option>
                <option value="72">72개월</option>
                <option value="84">84개월</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">할부 금액</label>
              <input type="number" id="loan-amount" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="자동 계산" readonly>
            </div>
          </div>
          
          <button id="calculate-btn" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors" disabled>
            할부 견적 계산하기
          </button>
        </div>
      </div>

      <!-- Right: Loan Estimates -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-sm p-6 sticky top-6">
          <h2 class="text-xl font-semibold text-gray-900 mb-4">할부 견적 비교</h2>
          
          <div id="estimates-container" class="space-y-4">
            <div class="text-center py-8 text-gray-500">
              <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              <p>차량과 조건을 선택하면<br>할부 견적이 표시됩니다</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quote Popup Modal -->
<div id="quote-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
      <div id="quote-content">
        <!-- Quote content will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
  const carData = {
    "현대": {
      "아반떼": { price: 20900000, image: "/generated_images/car_1.jpg" },
      "쏘나타": { price: 28990000, image: "/generated_images/car_2.jpg" },
      "그랜저": { price: 35200000, image: "/generated_images/car_3.jpg" },
      "아이오닉5": { price: 52000000, image: "/generated_images/car_1.jpg" },
      "아이오닉6": { price: 52900000, image: "/generated_images/car_2.jpg" },
      "투싼": { price: 27550000, image: "/generated_images/car_3.jpg" },
      "싼타페": { price: 35150000, image: "/generated_images/car_4.jpg" },
      "팰리세이드": { price: 38380000, image: "/generated_images/car_5.jpg" },
      "캐스퍼": { price: 13850000, image: "/generated_images/car_6.jpg" },
      "베뉴": { price: 19690000, image: "/generated_images/car_1.jpg" }
    },
    "기아": {
      "K3": { price: 19550000, image: "/generated_images/car_4.jpg" },
      "K5": { price: 27600000, image: "/generated_images/car_5.jpg" },
      "K8": { price: 33050000, image: "/generated_images/car_6.jpg" },
      "K9": { price: 46300000, image: "/generated_images/car_1.jpg" },
      "EV6": { price: 48800000, image: "/generated_images/car_2.jpg" },
      "EV9": { price: 73000000, image: "/generated_images/car_3.jpg" },
      "셀토스": { price: 22680000, image: "/generated_images/car_4.jpg" },
      "스포티지": { price: 27550000, image: "/generated_images/car_5.jpg" },
      "쏘렌토": { price: 31930000, image: "/generated_images/car_6.jpg" },
      "모하비": { price: 41730000, image: "/generated_images/car_1.jpg" },
      "레이": { price: 14350000, image: "/generated_images/car_2.jpg" },
      "모닝": { price: 12850000, image: "/generated_images/car_3.jpg" }
    },
    "제네시스": {
      "G70": { price: 45000000, image: "/generated_images/car_4.jpg" },
      "G80": { price: 54050000, image: "/generated_images/car_5.jpg" },
      "G90": { price: 87000000, image: "/generated_images/car_6.jpg" },
      "GV70": { price: 50300000, image: "/generated_images/car_1.jpg" },
      "GV80": { price: 69300000, image: "/generated_images/car_2.jpg" },
      "GV60": { price: 59900000, image: "/generated_images/car_3.jpg" },
      "전동화 G80": { price: 77550000, image: "/generated_images/car_4.jpg" },
      "전동화 GV70": { price: 65800000, image: "/generated_images/car_5.jpg" }
    },
    "BMW": {
      "1시리즈": { price: 42000000, image: "/generated_images/car_6.jpg" },
      "2시리즈": { price: 48900000, image: "/generated_images/car_1.jpg" },
      "3시리즈": { price: 55000000, image: "/generated_images/car_2.jpg" },
      "4시리즈": { price: 62000000, image: "/generated_images/car_3.jpg" },
      "5시리즈": { price: 74000000, image: "/generated_images/car_4.jpg" },
      "7시리즈": { price: 139000000, image: "/generated_images/car_5.jpg" },
      "X1": { price: 47500000, image: "/generated_images/car_6.jpg" },
      "X3": { price: 62000000, image: "/generated_images/car_1.jpg" },
      "X5": { price: 89000000, image: "/generated_images/car_2.jpg" },
      "X7": { price: 124000000, image: "/generated_images/car_3.jpg" },
      "iX3": { price: 77000000, image: "/generated_images/car_4.jpg" },
      "i4": { price: 69990000, image: "/generated_images/car_5.jpg" }
    },
    "벤츠": {
      "A클래스": { price: 42000000, image: "/generated_images/car_6.jpg" },
      "C클래스": { price: 55000000, image: "/generated_images/car_1.jpg" },
      "E클래스": { price: 72000000, image: "/generated_images/car_2.jpg" },
      "S클래스": { price: 135000000, image: "/generated_images/car_3.jpg" },
      "GLA": { price: 47500000, image: "/generated_images/car_4.jpg" },
      "GLB": { price: 52000000, image: "/generated_images/car_5.jpg" },
      "GLC": { price: 64000000, image: "/generated_images/car_6.jpg" },
      "GLE": { price: 89000000, image: "/generated_images/car_1.jpg" },
      "GLS": { price: 128000000, image: "/generated_images/car_2.jpg" },
      "EQA": { price: 59990000, image: "/generated_images/car_3.jpg" },
      "EQB": { price: 64990000, image: "/generated_images/car_4.jpg" },
      "EQC": { price: 89990000, image: "/generated_images/car_5.jpg" }
    },
    "아우디": {
      "A3": { price: 42000000, image: "/generated_images/car_6.jpg" },
      "A4": { price: 55000000, image: "/generated_images/car_1.jpg" },
      "A6": { price: 72000000, image: "/generated_images/car_2.jpg" },
      "A8": { price: 129000000, image: "/generated_images/car_3.jpg" },
      "Q2": { price: 41000000, image: "/generated_images/car_4.jpg" },
      "Q3": { price: 48900000, image: "/generated_images/car_5.jpg" },
      "Q5": { price: 64000000, image: "/generated_images/car_6.jpg" },
      "Q7": { price: 92000000, image: "/generated_images/car_1.jpg" },
      "Q8": { price: 105000000, image: "/generated_images/car_2.jpg" },
      "e-tron": { price: 99990000, image: "/generated_images/car_3.jpg" },
      "e-tron GT": { price: 139990000, image: "/generated_images/car_4.jpg" }
    },
    "볼보": {
      "XC40": { price: 45900000, image: "/generated_images/car_5.jpg" },
      "XC60": { price: 62000000, image: "/generated_images/car_6.jpg" },
      "XC90": { price: 82000000, image: "/generated_images/car_1.jpg" },
      "S60": { price: 49900000, image: "/generated_images/car_2.jpg" },
      "S90": { price: 65000000, image: "/generated_images/car_3.jpg" },
      "XC40 리차지": { price: 59990000, image: "/generated_images/car_4.jpg" },
      "XC60 리차지": { price: 74990000, image: "/generated_images/car_5.jpg" },
      "XC90 리차지": { price: 94990000, image: "/generated_images/car_6.jpg" }
    },
    "렉서스": {
      "IS": { price: 47000000, image: "/generated_images/car_1.jpg" },
      "ES": { price: 55000000, image: "/generated_images/car_2.jpg" },
      "LS": { price: 119000000, image: "/generated_images/car_3.jpg" },
      "NX": { price: 52000000, image: "/generated_images/car_4.jpg" },
      "RX": { price: 72000000, image: "/generated_images/car_5.jpg" },
      "GX": { price: 95000000, image: "/generated_images/car_6.jpg" },
      "LX": { price: 135000000, image: "/generated_images/car_1.jpg" },
      "UX": { price: 42000000, image: "/generated_images/car_2.jpg" },
      "LC": { price: 129000000, image: "/generated_images/car_3.jpg" }
    }
  };

  let selectedBrand = '<%= @brand %>';
  let selectedModel = '<%= @model %>';

  document.addEventListener('DOMContentLoaded', function() {
    const brandSelect = document.getElementById('brand-select');
    const modelSelect = document.getElementById('model-select');
    const calculateBtn = document.getElementById('calculate-btn');
    
    // Initialize if brand is pre-selected
    if (selectedBrand) {
      updateModels();
      if (selectedModel) {
        updateCarDisplay();
      }
    }

    brandSelect.addEventListener('change', function() {
      selectedBrand = this.value;
      selectedModel = '';
      updateModels();
      hideCarDisplay();
      clearEstimates();
    });

    modelSelect.addEventListener('change', function() {
      selectedModel = this.value;
      updateCarDisplay();
      clearEstimates();
    });

    document.getElementById('down-payment').addEventListener('input', calculateLoanAmount);
    document.getElementById('loan-period').addEventListener('change', validateForm);
    
    calculateBtn.addEventListener('click', calculateEstimates);
  });

  function updateModels() {
    const modelSelect = document.getElementById('model-select');
    modelSelect.innerHTML = '<option value="">모델 선택</option>';
    
    if (selectedBrand && carData[selectedBrand]) {
      modelSelect.disabled = false;
      Object.keys(carData[selectedBrand]).forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        if (model === selectedModel) option.selected = true;
        modelSelect.appendChild(option);
      });
    } else {
      modelSelect.disabled = true;
    }
  }

  function updateCarDisplay() {
    if (selectedBrand && selectedModel && carData[selectedBrand][selectedModel]) {
      const carInfo = carData[selectedBrand][selectedModel];
      document.getElementById('selected-car').classList.remove('hidden');
      document.getElementById('car-image').src = carInfo.image;
      document.getElementById('car-name').textContent = `${selectedBrand} ${selectedModel}`;
      document.getElementById('car-price').textContent = `₩${carInfo.price.toLocaleString()}`;
      document.getElementById('car-price-input').value = carInfo.price;
      calculateLoanAmount();
    }
  }

  function hideCarDisplay() {
    document.getElementById('selected-car').classList.add('hidden');
    document.getElementById('car-price-input').value = '';
    document.getElementById('loan-amount').value = '';
  }

  function calculateLoanAmount() {
    const carPrice = parseInt(document.getElementById('car-price-input').value) || 0;
    const downPayment = parseInt(document.getElementById('down-payment').value) || 0;
    const loanAmount = carPrice - downPayment;
    document.getElementById('loan-amount').value = loanAmount > 0 ? loanAmount : 0;
    validateForm();
  }

  function validateForm() {
    const carPrice = document.getElementById('car-price-input').value;
    const loanPeriod = document.getElementById('loan-period').value;
    const calculateBtn = document.getElementById('calculate-btn');
    
    if (carPrice && loanPeriod) {
      calculateBtn.disabled = false;
    } else {
      calculateBtn.disabled = true;
    }
  }

  function calculateEstimates() {
    const carPrice = document.getElementById('car-price-input').value;
    const downPayment = document.getElementById('down-payment').value || 0;
    const loanPeriod = document.getElementById('loan-period').value;
    
    fetch('/estimates/calculate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify({
        brand: selectedBrand,
        model: selectedModel,
        price: carPrice,
        down_payment: downPayment,
        loan_period: loanPeriod
      })
    })
    .then(response => response.json())
    .then(data => {
      displayEstimates(data.estimates, data.car_info);
    })
    .catch(error => {
      console.error('Error:', error);
    });
  }

  function displayEstimates(estimates, carInfo) {
    const container = document.getElementById('estimates-container');
    container.innerHTML = '';
    
    estimates.forEach((estimate, index) => {
      const estimateCard = document.createElement('div');
      estimateCard.className = 'border border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-colors cursor-pointer';
      estimateCard.innerHTML = `
        <div class="flex justify-between items-start mb-2">
          <div>
            <h3 class="font-semibold text-gray-900">${estimate.bank}</h3>
            <p class="text-sm text-gray-600">${estimate.type}</p>
          </div>
          <span class="text-sm font-medium text-blue-600">연 ${estimate.interest_rate}%</span>
        </div>
        <div class="mb-3">
          <p class="text-lg font-bold text-gray-900">월 ${estimate.monthly_payment.toLocaleString()}원</p>
          <p class="text-sm text-gray-600">총 ${estimate.total_payment.toLocaleString()}원</p>
        </div>
        <div class="mb-3">
          ${estimate.benefits.map(benefit => `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1 mb-1">${benefit}</span>`).join('')}
        </div>
        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded text-sm font-medium transition-colors" onclick="showQuotePopup('${estimate.bank}', '${estimate.type}', ${estimate.monthly_payment}, '${selectedBrand}', '${selectedModel}', ${carInfo.price})">
          견적서 보기
        </button>
      `;
      container.appendChild(estimateCard);
    });
  }

  function clearEstimates() {
    const container = document.getElementById('estimates-container');
    container.innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
        </svg>
        <p>차량과 조건을 선택하면<br>할부 견적이 표시됩니다</p>
      </div>
    `;
  }

  function showQuotePopup(bank, type, monthlyPayment, brand, model, price) {
    const modal = document.getElementById('quote-modal');
    const content = document.getElementById('quote-content');
    
    fetch(`/estimates/quote_popup?bank=${encodeURIComponent(bank)}&estimate_type=${encodeURIComponent(type)}&monthly_payment=${monthlyPayment}&brand=${encodeURIComponent(brand)}&model=${encodeURIComponent(model)}&price=${price}`)
      .then(response => response.text())
      .then(html => {
        content.innerHTML = html;
        modal.classList.remove('hidden');
      })
      .catch(error => {
        console.error('Error:', error);
      });
  }

  // Close modal when clicking outside
  document.getElementById('quote-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.classList.add('hidden');
    }
  });
</script>